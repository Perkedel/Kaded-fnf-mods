# This is a basic workflow to help you get started with Actions

name: Windows Droid Build CI

# Controls when the workflow will run
on: [push, pull_request]

env:
  ANDROID_SDK_LOC: C:\Android\android-sdk
  ANDROID_NDK_ROOT_LOC: C:\Android
  ANDROID_CMD_LOC: C:\projects\android-cmd

permissions:
  contents: write

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: windows-latest
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - uses: krdlab/setup-haxe@v1.1.6
        with:
          haxe-version: 4.2.4
      # Runs a set of commands using the runners shell

      - name: Schlob Chocolatey
        run: |
          choco install vcredist140
          cinst make -y
          cinst cmake -y
          cinst gcc-arm -y
          cinst gcc-arm-embedded -y
          cinst wget -y # downloader
          cinst butler -y # upload to itch io
          cinst android-sdk -y
          cinst android-ndk --version=16.2 -y
          cinst adb -y
          cinst androidstudio -y

      - name: first, lemme download android stuff
        run: |
          wget -q -O android_ndk.zip https://dl.google.com/android/repository/android-ndk-r15c-windows-x86_64.zip?hl=fi
          wget -q -O android_cmd.zip https://dl.google.com/android/repository/commandlinetools-win-7302050_latest.zip
          wget -q -O android_build-tools.zip https://dl.google.com/android/repository/build-tools_r30.0.1-windows.zip
          wget -q -O android_platforms.zip https://dl.google.com/android/repository/android-19_r04.zip
          wget -q -O android_platform-tools.zip https://dl.google.com/android/repository/platform-tools_r31.0.2-windows.zip
          unzip -q .\android_ndk.zip -d %ANDROID_NDK_ROOT_LOC%
          unzip -q .\android_cmd.zip -d %ANDROID_SDK_LOC%
          unzip -q -n .\android_build-tools.zip -d %ANDROID_SDK_LOC%\build-tools
          unzip -q .\android_platforms.zip -d %ANDROID_SDK_LOC%
          unzip -q -n .\android_platform-tools.zip -d %ANDROID_SDK_LOC% 

      - name: script run line haha
        run: |
          cinst haxe -y
          RefreshEnv
          haxelib install lime
          RefreshEnv
          haxelib install openfl
          haxelib install flixel
          haxelib run lime setup flixel -y
          haxelib run lime setup -y
          haxelib install flixel-tools
          haxelib install flixel-addons
          haxelib install flixel-ui
          haxelib install hscript
          haxelib install flixel-addons
          haxelib git faxe https://github.com/uhrobots/faxe
          haxelib install polymod
          haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc
          haxelib git extension-webm https://github.com/GrowtopiaFli/extension-webm
          haxelib run lime rebuild extension-webm windows
          haxelib run lime rebuild extension-webm android
          haxelib install android6permissions
          haxelib git haxe-hardware https://github.com/Perkedel/haxe-hardware.git
          haxelib git hscript-ex https://github.com/ianharrigan/hscript-ex # for the alternative against Lua, like BulbyVR's FNFM+
          haxelib install tjson #BulbyVR used TJSON for JSON parsing instead of built-in JSON handlers.
          haxelib install uniontypes #BulbyVR used this
          haxelib install json2object #BulbyVR used this to convert JSON to object
          haxelib install extension-webview #luckydog7 for Android
          haxelib git xinput https://github.com/furusystems/openfl-xinput.git
          haxelib install haxe-files
          haxelib install hxcpp-debug-server
          haxelib install tink_core
          haxelib install grig.audio
          haxelib install grig.midi
          haxelib git linc_luajit https://github.com/nebulazorua/linc_luajit.git
          haxelib git hxvm-luajit https://github.com/nebulazorua/hxvm-luajit
          haxelib install actuate 
          haxelib git tentools https://github.com/TentaRJ/tentools.git
          haxelib git systools https://github.com/haya3218/systools
          haxelib run lime rebuild systools windows
          haxelib run lime rebuild systools android
          haxelib install haxe-strings
          haxelib install firetongue
          haxelib install hxp
          haxelib install svg
          haxelib install format
          haxelib install lime-tools
          haxelib install haxeui
          haxelib install haxeui-core
          haxelib install haxeui-openfl
          haxelib install haxeui-flixel
          haxelib git openfl-xinput https://github.com/furusystems/openfl-xinput
          haxelib install yagp
          haxelib list
          dir
          pwd
      
      - name: Obtain stuffs of Windows?
        run: |
          mkdir -p C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\Aarch64
          mkdir -p C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\arm
          mkdir -p C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\x86
          wget https://github.com/JOELwindows7/linc_luajit/raw/master/lib/Lua/lib/Android/Aarch64/libluajit-5.1.so
          wget https://github.com/JOELwindows7/linc_luajit/raw/master/lib/Lua/lib/Android/Aarch64/libluajit.so
          mv .\libluajit-5.1.so C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\Aarch64
          mv .\libluajit.so C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\Aarch64
          wget https://github.com/JOELwindows7/linc_luajit/raw/master/lib/Lua/lib/Android/arm/libluajit-5.1.so
          wget https://github.com/JOELwindows7/linc_luajit/raw/master/lib/Lua/lib/Android/arm/libluajit.so
          mv .\libluajit-5.1.so C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\arm
          mv .\libluajit.so C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\arm
          wget https://github.com/JOELwindows7/linc_luajit/raw/master/lib/Lua/lib/Android/x86/libluajit-5.1.so
          wget https://github.com/JOELwindows7/linc_luajit/raw/master/lib/Lua/lib/Android/x86/libluajit.so
          mv .\libluajit-5.1.so C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\x86
          mv .\libluajit.so C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\linc_luajit\lib\Lua\lib\Android\x86
      
      - name: TEMP patch FlxAction.hx workaround
        run: |
          dir C:\
          dir C:\hostedtoolcache
          dir "C:\hostedtoolcache\windows"
          dir "C:\hostedtoolcache\windows\haxe"
          dir "C:\hostedtoolcache\windows\haxe\4.2.4"
          dir "C:\hostedtoolcache\windows\haxe\4.2.4\x64"
          dir "C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib"
          dir "C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\flixel"
          wget "https://gist.github.com/JOELwindows7/118b3a40a76d60e701399a61fb5e1c2d/raw/fef2b6649a4b51d76f912459ef3f107b4bd25905/FlxAction.hx"
          dir
          pwd
          mv ".\FlxAction.hx" "C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\flixel\4,11,0\flixel\input\actions\FlxAction.hx" -Force
      
      - name: Setup Android support
        run: |
          haxelib run lime config ANDROID_SDK %ANDROID_SDK_LOC%
          haxelib run lime config ANDROID_NDK_ROOT %ANDROID_NDK_ROOT_LOC%\android-ndk-r15c
          haxelib run lime config ANDROID_SETUP true
          haxelib run lime config JAVA_HOME C:\Program Files\Java\jdk1.8.0_211
      
      - name: Manual Android NDLL download for extension-webm
        run: |
          wget https://github.com/Perkedel/After-Church/raw/master/RAW%20files/stray%20anything/Borkarounds/extension-webm/ndll/Android.zip
          unzip .\Android.zip
          mv ".\Android" "C:\hostedtoolcache\windows\haxe\4.2.4\x64\lib\extension-webm\git\ndll"
        
      - name: Obtain Gamejolt empty key
        run : |
          wget https://gist.github.com/JOELwindows7/ba79db473ab5e4765293fb19c62240cb/raw/d5fc74359ec9ae272003c5d715d04b4dbbd7810d/GJkeys.hx
          mv .\GJkeys.hx D:\a\Kaded-fnf-mods\Kaded-fnf-mods\source\GJKeys.hx
      
      - name: Oh peck, I can't believe you've done this
        run: |
          echo butler check
          butler -h
          ls
          pwd
      
      - name: build Android now!
        run: |
          haxelib run lime build android -final
      
      - name: Artifact Android now
        uses: actions/upload-artifact@v2.2.4
        with:
          name: Android Build
          path: export/release/android/bin/app/build/output/apk/Last Funkin Moments-debug.apk
      
      - name: Manually push to Itch WinDroid because that Action container only support Linux wtf bro
        env: 
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_CREDENTIALS }}
          BUTLER_API_KEY: ${{ secrets.BUTLER_CREDENTIALS }}
        run: |
          ls
          pwd
          butler push D:\a\Kaded-fnf-mods\Kaded-fnf-mods\export\release\android\bin\app\build\output\apk\Last Funkin Moments-debug.apk joelwindows7/last-funkin-moments:android-GHAction
      
      - name: Yo, release now
        uses: softprops/action-gh-release@v0.1.13
        if: startsWith(github.ref, 'refs/tags/')

